name: Server CI/CD

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'polish/server/**'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'polish/server/**'

jobs:
  test:
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./polish/server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./polish/server/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Run linting
      run: npm run lint 2>/dev/null || echo "No lint script defined"

    - name: Run tests
      run: npm test
      env:
        NODE_ENV: test
        JWT_SECRET: test-jwt-secret-for-ci

    - name: Upload coverage reports
      uses: codecov/codecov-action@v3
      with:
        file: ./polish/server/coverage/lcov.info
        flags: server
        name: server-coverage
        fail_ci_if_error: false

  build:
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    defaults:
      run:
        working-directory: ./polish/server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: ./polish/server/package-lock.json

    - name: Install dependencies
      run: npm ci

    - name: Build application
      run: npm run build

    - name: Run security audit
      run: npm audit --audit-level moderate

    - name: Build Docker image
      run: |
        docker build -t polish-server:${{ github.sha }} .
        docker tag polish-server:${{ github.sha }} polish-server:latest

    - name: Save Docker image
      run: |
        docker save polish-server:latest > server-image.tar

    - name: Upload build artifacts
      uses: actions/upload-artifact@v4
      with:
        name: server-build
        path: |
          ./polish/server/dist/
          ./polish/server/server-image.tar
          ./polish/server/package.json
          ./polish/server/package-lock.json

  deploy-staging:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment: staging
    defaults:
      run:
        working-directory: ./polish/server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: server-build

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci --production

    - name: Deploy to staging
      run: |
        echo "Deploying to staging environment"
        # Add your staging deployment commands here
        # For example: rsync, scp, or cloud deployment commands
      env:
        STAGING_HOST: ${{ secrets.STAGING_HOST }}
        STAGING_USER: ${{ secrets.STAGING_USER }}
        STAGING_KEY: ${{ secrets.STAGING_SSH_KEY }}

  deploy-production:
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment: production
    defaults:
      run:
        working-directory: ./polish/server

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: server-build

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'

    - name: Install dependencies
      run: npm ci --production

    - name: Run pre-deployment tests
      run: npm test
      env:
        NODE_ENV: production
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
        COSMOS_ENDPOINT: ${{ secrets.COSMOS_ENDPOINT }}
        COSMOS_KEY: ${{ secrets.COSMOS_KEY }}
        COSMOS_DATABASE: ${{ secrets.COSMOS_DATABASE }}

    - name: Deploy to production
      run: |
        echo "Deploying to production environment"
        # Add your production deployment commands here
      env:
        PROD_HOST: ${{ secrets.PROD_HOST }}
        PROD_USER: ${{ secrets.PROD_USER }}
        PROD_SSH_KEY: ${{ secrets.PROD_SSH_KEY }}
        COSMOS_ENDPOINT: ${{ secrets.COSMOS_ENDPOINT }}
        COSMOS_KEY: ${{ secrets.COSMOS_KEY }}
        COSMOS_DATABASE: ${{ secrets.COSMOS_DATABASE }}
        AZURE_STORAGE_ACCOUNT: ${{ secrets.AZURE_STORAGE_ACCOUNT }}
        AZURE_STORAGE_KEY: ${{ secrets.AZURE_STORAGE_KEY }}
        AZURE_STORAGE_CONTAINER: ${{ secrets.AZURE_STORAGE_CONTAINER }}
        OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        AUTH0_DOMAIN: ${{ secrets.AUTH0_DOMAIN }}
        AUTH0_AUDIENCE: ${{ secrets.AUTH0_AUDIENCE }}
        JWT_SECRET: ${{ secrets.JWT_SECRET }}
