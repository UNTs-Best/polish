openapi: 3.1.0
info:
  title: Polish API
  version: 1.0.0
  description: |
    Production-grade backend API for **Polish** — the AI-powered, real-time collaborative document editor.
    Features: Auth0 JWT, Cosmos DB, SignalR streaming, OpenAI gpt-4o, multi-format export, version control, templates, accessibility (WCAG 2.1 AA).
  contact:
    name: UNT's Best — Arnav Verma
    url: https://github.com/arnav-verma/polish
    email: arnav@polish.app
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.polish.app/v1
    description: Production (Azure App Service)
  - url: http://localhost:5000/v1
    description: Local development

tags:
  - name: Auth
    description: Authentication via Auth0
  - name: Documents
    description: CRUD + real-time collaboration
  - name: Versions
    description: Document history and restore
  - name: LLM
    description: AI-powered editing, summarization, templates
  - name: Export
    description: PDF, DOCX, LaTeX, Markdown
  - name: Templates
    description: AI-generated document starters
  - name: Realtime
    description: SignalR + WebSocket + SSE
  - name: Webhooks
    description: Event notifications
  - name: Audit
    description: Security and activity logs

paths:
  # ──────────────────────────────────────
  # AUTH (Auth0)
  # ──────────────────────────────────────
  /auth/me:
    get:
      summary: Get current user profile
      tags: [Auth]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          description: Auth0 user profile
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'

  /auth/logout:
    post:
      summary: Invalidate session (client-side)
      tags: [Auth]
      responses:
        '204': { description: Logged out }

  # ──────────────────────────────────────
  # DOCUMENTS
  # ──────────────────────────────────────
  /docs:
    get:
      summary: List all documents for user
      tags: [Documents]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: search
          in: query
          schema: { type: string }
        - name: limit
          in: query
          schema: { type: integer, default: 20 }
        - name: cursor
          in: query
          schema: { type: string }
      responses:
        '200':
          description: Paginated document list
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DocumentList'

    post:
      summary: Create new document
      tags: [Documents]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentCreateRequest'
      responses:
        '201':
          description: Document created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  /docs/{id}:
    get:
      summary: Get document by ID
      tags: [Documents]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Full document
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

    patch:
      summary: Partial update (for real-time OT)
      tags: [Documents, Realtime]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/DocumentPatch'
      responses:
        '200':
          description: Patch applied

    delete:
      summary: Delete document
      tags: [Documents]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '204': { description: Deleted }

  # ──────────────────────────────────────
  # VERSIONS
  # ──────────────────────────────────────
  /docs/{id}/versions:
    get:
      summary: List versions
      tags: [Versions]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Version'

  /docs/{id}/versions/{versionId}/restore:
    post:
      summary: Restore specific version
      tags: [Versions]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
        - name: versionId
          in: path
          required: true
      responses:
        '200':
          description: Restored
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Document'

  # ──────────────────────────────────────
  # LLM ENDPOINTS
  # ──────────────────────────────────────
  /llm/suggest:
    post:
      summary: Get AI writing suggestions
      tags: [LLM]
      security: [{ bearerAuth: [] }]
      requestBody:
        $ref: '#/components/requestBodies/LLMSuggest'
      responses:
        '200':
          $ref: '#/components/responses/LLMSuggest'

  /llm/stream:
    post:
      summary: Stream AI response (SSE)
      tags: [LLM, Realtime]
      security: [{ bearerAuth: [] }]
      requestBody:
        $ref: '#/components/requestBodies/LLMStream'
      responses:
        '200':
          description: text/event-stream
          content:
            text/event-stream:
              schema:
                type: string
                example: data: {"delta": "Hello", "finish_reason": null}

  /llm/summarize:
    post:
      summary: Summarize document
      tags: [LLM]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LLMSummarizeRequest'
      responses:
        '200':
          $ref: '#/components/responses/LLMSummarize'

  /llm/templates:
    get:
      summary: List AI template starters
      tags: [Templates]
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Template'

  # ──────────────────────────────────────
  # EXPORT
  # ──────────────────────────────────────
  /docs/{id}/export:
    post:
      summary: Export document
      tags: [Export]
      security: [{ bearerAuth: [] }]
      parameters:
        - name: id
          in: path
          required: true
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                format:
                  type: string
                  enum: [pdf, docx, latex, md]
                includeBibTeX:
                  type: boolean
                  default: false
      responses:
        '200':
          description: Presigned download URL
          content:
            application/json:
              schema:
                type: object
                properties:
                  url:
                    type: string
                    format: uri
                  expiresIn:
                    type: integer

  # ──────────────────────────────────────
  # REALTIME (SignalR fallback)
  # ──────────────────────────────────────
  /realtime/negotiate:
    get:
      summary: SignalR negotiation
      tags: [Realtime]
      security: [{ bearerAuth: [] }]
      responses:
        '200':
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SignalRInfo'

  # ──────────────────────────────────────
  # WEBHOOKS & AUDIT
  # ──────────────────────────────────────
  /webhooks:
    get:
      summary: List webhooks
      tags: [Webhooks]
      security: [{ bearerAuth: [] }]
      responses: { '200': { description: OK } }
    post:
      summary: Register webhook
      tags: [Webhooks]
      security: [{ bearerAuth: [] }]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                url: { type: string }
                events: { type: array, items: { type: string } }
      responses: { '201': { description: Created } }

  /audit:
    get:
      summary: Activity log (admin only)
      tags: [Audit]
      security: [{ bearerAuth: [], adminAuth: [] }]
      responses:
        '200':
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AuditLog'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: Auth0 JWT (RS256)
    adminAuth:
      type: apiKey
      in: header
      name: X-Admin-Key

  schemas:
    UserProfile:
      type: object
      properties:
        sub: { type: string }
        email: { type: string }
        name: { type: string }
        picture: { type: string }

    Document:
      type: object
      properties:
        id: { type: string }
        title: { type: string }
        content: { type: string }
        ownerId: { type: string }
        collaborators: { type: array, items: { type: string } }
        createdAt: { type: string, format: date-time }
        updatedAt: { type: string, format: date-time }
        version: { type: integer }

    DocumentList:
      type: object
      properties:
        items: { type: array, items: { $ref: '#/components/schemas/Document' } }
        nextCursor: { type: string, nullable: true }

    DocumentCreateRequest:
      type: object
      required: [title]
      properties:
        title: { type: string }
        content: { type: string }
        templateId: { type: string }

    DocumentPatch:
      type: object
      properties:
        ops:
          type: array
          items:
            type: object
            properties:
              op: { type: string, enum: [insert, delete, replace] }
              path: { type: string }
              value: { type: string }

    Version:
      type: object
      properties:
        versionId: { type: string }
        timestamp: { type: string, format: date-time }
        author: { type: string }
        changeCount: { type: integer }

    Template:
      type: object
      properties:
        id: { type: string }
        name: { type: string }
        category: { type: string }
        preview: { type: string }

    SignalRInfo:
      type: object
      properties:
        url: { type: string }
        accessToken: { type: string }

    AuditLog:
      type: object
      properties:
        id: { type: string }
        userId: { type: string }
        action: { type: string }
        timestamp: { type: string, format: date-time }
        ip: { type: string }
        userAgent: { type: string }

  requestBodies:
    LLMSuggest:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              text: { type: string }
              selection: { type: string }
              tone: { type: string, enum: [formal, casual, persuasive, concise, academic] }
              instruction: { type: string }
    LLMStream:
      required: true
      content:
        application/json:
          schema:
            type: object
            properties:
              prompt: { type: string }
              documentId: { type: string }
              model: { type: string, default: gpt-4o-mini }

  responses:
    LLMSuggest:
      description: AI suggestion with diff
      content:
        application/json:
          schema:
            type: object
            properties:
              suggestion: { type: string }
              diff: { type: string }
              model: { type: string }
              tokens: { type: integer }

    LLMSummarize:
      description: Summary
      content:
        application/json:
          schema:
            type: object
            properties:
              summary: { type: string }
              wordCount: { type: integer }
              readingTime: { type: string }